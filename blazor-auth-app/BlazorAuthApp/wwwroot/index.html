<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>BlazorAuthApp</title>
    <base href="/" />
    <link rel="preload" id="webassembly" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css?v=2" />
    <link rel="stylesheet" href="css/app.css?v=2" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="BlazorAuthApp.styles.css?v=2" rel="stylesheet" />
    <script type="importmap"></script>
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">ðŸ—™</span>
    </div>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    <script src="_framework/blazor.webassembly#[.{fingerprint}].js"></script>
    <script>
        window.qrScanner = {
            scanner: null,
            start: function (videoElementId, dotnetHelper) {
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                this.scanner = new Html5Qrcode(videoElementId);
                
                this.scanner.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText, decodedResult) => {
                        dotnetHelper.invokeMethodAsync('OnQRCodeScanned', decodedText);
                        this.stop();
                    },
                    (errorMessage) => {
                        // Ignore scan errors
                    }
                ).catch(err => {
                    console.error('Camera start error:', err);
                    dotnetHelper.invokeMethodAsync('OnScanError', err.toString());
                });
            },
            stop: function () {
                if (this.scanner) {
                    this.scanner.stop().then(() => {
                        console.log('Scanner stopped');
                    }).catch(err => {
                        console.error('Stop error:', err);
                    });
                }
            }
        };

        window.faceRecognition = {
            video: null,
            stream: null,
            isModelsLoaded: false,
            dotnetHelper: null,

            loadModels: async function () {
                if (this.isModelsLoaded) return true;
                
                try {
                    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
                    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                    this.isModelsLoaded = true;
                    console.log('Face-api models loaded successfully');
                    return true;
                } catch (error) {
                    console.error('Error loading face-api models:', error);
                    return false;
                }
            },

            start: async function (videoElementId, dotnetHelper) {
                this.dotnetHelper = dotnetHelper;
                
                // Load models first
                const modelsLoaded = await this.loadModels();
                if (!modelsLoaded) {
                    dotnetHelper.invokeMethodAsync('OnFaceError', 'Failed to load face recognition models. Please check your internet connection.');
                    return;
                }

                try {
                    // Check if getUserMedia is supported
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        dotnetHelper.invokeMethodAsync('OnFaceError', 'Camera not supported in this browser. Please use a modern browser like Chrome, Firefox, or Edge.');
                        return;
                    }

                    this.video = document.getElementById(videoElementId);
                    if (!this.video) {
                        dotnetHelper.invokeMethodAsync('OnFaceError', 'Video element not found.');
                        return;
                    }

                    console.log('Requesting camera access...');
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    });
                    
                    this.video.srcObject = this.stream;
                    await this.video.play();

                    // Wait for video to be ready
                    await new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            resolve();
                        };
                    });

                    console.log('Face recognition camera started');
                    dotnetHelper.invokeMethodAsync('OnCameraReady');
                } catch (error) {
                    console.error('Camera access error:', error);
                    let errorMessage = 'Camera access error.';
                    
                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMessage = 'Camera access denied. Please click the camera icon in your browser\'s address bar and allow camera access, then try again.';
                    } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                        errorMessage = 'No camera found. Please connect a camera and try again.';
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMessage = 'Camera is already in use by another application. Please close other apps using the camera and try again.';
                    } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                        errorMessage = 'Camera constraints not satisfied. Your camera may not support the required settings.';
                    } else if (error.name === 'TypeError') {
                        errorMessage = 'Camera access not supported. Please ensure you are using HTTPS or localhost.';
                    } else {
                        errorMessage = `Camera error: ${error.message || error.name || 'Unknown error'}`;
                    }
                    
                    dotnetHelper.invokeMethodAsync('OnFaceError', errorMessage);
                }
            },

            captureFace: async function () {
                try {
                    if (!this.video) {
                        throw new Error('Video not initialized');
                    }

                    console.log('Detecting face...');
                    const detection = await faceapi
                        .detectSingleFace(this.video, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptor();

                    if (!detection) {
                        this.dotnetHelper.invokeMethodAsync('OnFaceError', 'No face detected. Please position your face in the camera.');
                        return null;
                    }

                    console.log('Face detected successfully');
                    const descriptor = Array.from(detection.descriptor);
                    return JSON.stringify(descriptor);
                } catch (error) {
                    console.error('Face capture error:', error);
                    this.dotnetHelper.invokeMethodAsync('OnFaceError', 'Error capturing face: ' + error.message);
                    return null;
                }
            },

            stop: function () {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                if (this.video) {
                    this.video.srcObject = null;
                    this.video = null;
                }
                this.dotnetHelper = null;
                console.log('Face recognition stopped');
            }
        };
    </script>
</body>

</html>
