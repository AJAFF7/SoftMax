<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>BlazorAuthApp</title>
    <base href="/" />
    <link rel="preload" id="webassembly" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css?v=2" />
    <link rel="stylesheet" href="css/app.css?v=2" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="BlazorAuthApp.styles.css?v=2" rel="stylesheet" />
    <script type="importmap"></script>
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">ðŸ—™</span>
    </div>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    <script src="_framework/blazor.webassembly#[.{fingerprint}].js"></script>
    <script>
        window.qrScanner = {
            scanner: null,
            start: function (videoElementId, dotnetHelper) {
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                this.scanner = new Html5Qrcode(videoElementId);
                
                this.scanner.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText, decodedResult) => {
                        dotnetHelper.invokeMethodAsync('OnQRCodeScanned', decodedText);
                        this.stop();
                    },
                    (errorMessage) => {
                        // Ignore scan errors
                    }
                ).catch(err => {
                    console.error('Camera start error:', err);
                    dotnetHelper.invokeMethodAsync('OnScanError', err.toString());
                });
            },
            stop: function () {
                if (this.scanner) {
                    this.scanner.stop().then(() => {
                        console.log('Scanner stopped');
                    }).catch(err => {
                        console.error('Stop error:', err);
                    });
                }
            }
        };

        window.faceRecognition = {
            video: null,
            stream: null,
            isModelsLoaded: false,
            dotnetHelper: null,
            isDetecting: false,

            loadModels: async function () {
                if (this.isModelsLoaded) return true;
                
                try {
                    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
                    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                    this.isModelsLoaded = true;
                    console.log('Face-api models loaded successfully');
                    return true;
                } catch (error) {
                    console.error('Error loading face-api models:', error);
                    return false;
                }
            },

            start: async function (videoElementId, dotnetHelper) {
                console.log('[DEBUG] faceRecognition.start called with videoElementId:', videoElementId);
                this.dotnetHelper = dotnetHelper;
                
                // Load models first
                console.log('[DEBUG] Loading face-api models...');
                const modelsLoaded = await this.loadModels();
                if (!modelsLoaded) {
                    console.error('[DEBUG] Failed to load models');
                    dotnetHelper.invokeMethodAsync('OnFaceError', 'Failed to load face recognition models. Please check your internet connection.');
                    return;
                }

                try {
                    // Check if getUserMedia is supported
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        dotnetHelper.invokeMethodAsync('OnFaceError', 'Camera not supported in this browser. Please use a modern browser like Chrome, Firefox, or Edge.');
                        return;
                    }

                    // Wait a bit and retry finding video element (for Blazor rendering)
                    console.log(`Looking for video element: ${videoElementId}`);
                    let attempts = 0;
                    let videoElement = null;
                    
                    while (attempts < 10 && !videoElement) {
                        videoElement = document.getElementById(videoElementId);
                        if (!videoElement) {
                            console.log(`Waiting for video element (attempt ${attempts + 1}/10)...`);
                            await new Promise(resolve => setTimeout(resolve, 200));
                            attempts++;
                        } else {
                            console.log(`Video element found on attempt ${attempts + 1}`);
                        }
                    }
                    
                    if (!videoElement) {
                        console.error(`Video element '${videoElementId}' not found after 10 attempts`);
                        dotnetHelper.invokeMethodAsync('OnFaceError', 'Video element not found. Please try again.');
                        return;
                    }

                    this.video = videoElement;
                    console.log('Video element found, requesting camera access...');

                    // Add timeout for camera access
                    const cameraPromise = navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    });

                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Camera access timeout - no response from browser after 10 seconds')), 10000)
                    );

                    this.stream = await Promise.race([cameraPromise, timeoutPromise]);
                    console.log('Camera stream obtained');
                    
                    this.video.srcObject = this.stream;
                    console.log('Video srcObject set, starting video play...');
                    await this.video.play();
                    console.log('Video playing...');

                    // Wait for video to be ready
                    await new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            console.log('Video metadata loaded');
                            resolve();
                        };
                    });

                    console.log('Face recognition camera started');
                    console.log('[DEBUG] Calling dotnetHelper.invokeMethodAsync(OnCameraReady)');
                    dotnetHelper.invokeMethodAsync('OnCameraReady');
                    
                    // Start automatic face detection
                    console.log('Starting automatic detection...');
                    this.startAutoDetection();
                } catch (error) {
                    console.error('Camera access error:', error);
                    console.error('Error name:', error.name);
                    console.error('Error message:', error.message);
                    let errorMessage = 'Camera access error.';
                    
                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMessage = 'Camera access denied. Please click the camera icon in your browser\'s address bar and allow camera access, then try again.';
                    } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                        errorMessage = 'No camera found. Please connect a camera and try again.';
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMessage = 'Camera is already in use by another application. Please close other apps using the camera and try again.';
                    } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                        errorMessage = 'Camera constraints not satisfied. Your camera may not support the required settings.';
                    } else if (error.name === 'TypeError') {
                        errorMessage = 'Camera access not supported. Please ensure you are using HTTPS or localhost.';
                    } else {
                        errorMessage = `Camera error: ${error.message || error.name || 'Unknown error'}`;
                    }
                    
                    dotnetHelper.invokeMethodAsync('OnFaceError', errorMessage);
                }
            },

            startAutoDetection: async function () {
                console.log('Starting automatic face detection...');
                this.isDetecting = true;
                
                const detectLoop = async () => {
                    if (!this.isDetecting || !this.video) {
                        return;
                    }

                    try {
                        // Detect face
                        const detection = await faceapi
                            .detectSingleFace(this.video, new faceapi.TinyFaceDetectorOptions())
                            .withFaceLandmarks()
                            .withFaceDescriptor();

                        if (detection) {
                            console.log('Face detected, sending for verification...');
                            const descriptor = Array.from(detection.descriptor);
                            const descriptorJson = JSON.stringify(descriptor);
                            
                            // Stop detection while processing
                            this.isDetecting = false;
                            
                            // Send to backend for comparison
                            this.dotnetHelper.invokeMethodAsync('OnFaceDetected', descriptorJson);
                        } else {
                            // No face detected, try again
                            setTimeout(detectLoop, 500);
                        }
                    } catch (error) {
                        console.error('Auto-detection error:', error);
                        setTimeout(detectLoop, 1000);
                    }
                };

                // Start the detection loop
                detectLoop();
            },

            captureFace: async function () {
                try {
                    if (!this.video) {
                        throw new Error('Video not initialized');
                    }

                    console.log('Detecting face...');
                    const detection = await faceapi
                        .detectSingleFace(this.video, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptor();

                    if (!detection) {
                        this.dotnetHelper.invokeMethodAsync('OnFaceError', 'No face detected. Please position your face in the camera.');
                        return null;
                    }

                    console.log('Face detected successfully');
                    const descriptor = Array.from(detection.descriptor);
                    return JSON.stringify(descriptor);
                } catch (error) {
                    console.error('Face capture error:', error);
                    this.dotnetHelper.invokeMethodAsync('OnFaceError', 'Error capturing face: ' + error.message);
                    return null;
                }
            },

            stop: function () {
                this.isDetecting = false;
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                if (this.video) {
                    this.video.srcObject = null;
                    this.video = null;
                }
                this.dotnetHelper = null;
                console.log('Face recognition stopped');
            }
        };
    </script>
</body>

</html>
