@page "/my-appointments"
@using BlazorAuthApp.Models
@using BlazorAuthApp.Services
@inject AppointmentService AppointmentService
@inject AssistantService AssistantService
@inject NavigationManager Navigation
@inject AuthService AuthService
@implements IDisposable

<PageTitle></PageTitle>

<div class="appointments-page">
    <div class="page-header">
        <h1 class="page-title"></h1>
        <button class="btn-new-appointment" @onclick="GoToDoctors">
            + Book New Appointment
        </button>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading your appointments...</p>
        </div>
    }
    else if (!appointments.Any())
    {
        <div class="no-appointments">
            <div class="empty-state">
                <div class="empty-icon">üìÖ</div>
                <h2>No Appointments Yet</h2>
                <p>You haven't booked any appointments yet. Find a doctor and book your first appointment!</p>
                <button class="btn-primary" @onclick="GoToDoctors">
                    Find a Doctor
                </button>
            </div>
        </div>
    }
    else
    {
        <!-- Calendar and Chart Side by Side -->
        <div class="calendar-chart-wrapper">
            <!-- Doughnut Chart -->
            <div class="doughnut-chart-container">
                <h2 class="chart-title">Appointments by Doctor</h2>
                <div class="doughnut-wrapper">
                    <svg class="doughnut-chart" viewBox="0 0 200 200">
                        @{
                            var stats = GetDoctorStatistics();
                            var total = stats.Sum(s => s.Count);
                            var colors = new[] { "#4F46E5", "#10B981", "#F59E0B", "#EF4444", "#8B5CF6", "#EC4899", "#06B6D4", "#14B8A6", "#F97316" };
                            double currentAngle = -90;
                            var radius = 80;
                            var innerRadius = 50;
                            var centerX = 100;
                            var centerY = 100;
                        }
                        @for (int i = 0; i < stats.Count; i++)
                        {
                            var stat = stats[i];
                            var percentage = (double)stat.Count / total;
                            var angle = percentage * 360;
                            var startAngle = currentAngle;
                            var endAngle = currentAngle + angle;
                            
                            var startX = centerX + radius * Math.Cos(startAngle * Math.PI / 180);
                            var startY = centerY + radius * Math.Sin(startAngle * Math.PI / 180);
                            var endX = centerX + radius * Math.Cos(endAngle * Math.PI / 180);
                            var endY = centerY + radius * Math.Sin(endAngle * Math.PI / 180);
                            
                            var innerStartX = centerX + innerRadius * Math.Cos(startAngle * Math.PI / 180);
                            var innerStartY = centerY + innerRadius * Math.Sin(startAngle * Math.PI / 180);
                            var innerEndX = centerX + innerRadius * Math.Cos(endAngle * Math.PI / 180);
                            var innerEndY = centerY + innerRadius * Math.Sin(endAngle * Math.PI / 180);
                            
                            var largeArc = angle > 180 ? 1 : 0;
                            var color = colors[i % colors.Length];
                            
                            var path = $"M {startX:F2} {startY:F2} A {radius} {radius} 0 {largeArc} 1 {endX:F2} {endY:F2} L {innerEndX:F2} {innerEndY:F2} A {innerRadius} {innerRadius} 0 {largeArc} 0 {innerStartX:F2} {innerStartY:F2} Z";
                            
                            <path d="@path" fill="@color" class="doughnut-segment" />
                            
                            currentAngle = endAngle;
                        }
                        <circle cx="100" cy="100" r="@innerRadius" fill="rgba(255, 255, 255, 0.1)" />
                        <text x="100" y="95" text-anchor="middle" fill="white" font-size="20" font-weight="bold">@total</text>
                        <text x="100" y="110" text-anchor="middle" fill="rgba(255, 255, 255, 0.7)" font-size="12">Total</text>
                    </svg>
                    <div class="chart-legend">
                        @{
                            var legendStats = GetDoctorStatistics();
                            var legendColors = new[] { "#4F46E5", "#10B981", "#F59E0B", "#EF4444", "#8B5CF6", "#EC4899", "#06B6D4", "#14B8A6", "#F97316" };
                        }
                        @for (int i = 0; i < legendStats.Count; i++)
                        {
                            var stat = legendStats[i];
                            var color = legendColors[i % legendColors.Length];
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: @color;"></span>
                                <span class="legend-label">Dr. @stat.DoctorName</span>
                                <span class="legend-value">@stat.Count</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" @onclick="PreviousMonth">
                        ‚óÄ
                    </button>
                    <h2 class="calendar-title">@currentDate.ToString("MMMM yyyy")</h2>
                    <button class="calendar-nav-btn" @onclick="NextMonth">
                        ‚ñ∂
                    </button>
                </div>

            <div class="calendar-grid">
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>

                @foreach (var day in GetCalendarDays())
                {
                    var dayAppointments = GetAppointmentsForDay(day);
                    var isToday = day.Date == DateTime.Today;
                    var isCurrentMonth = day.Month == currentDate.Month;
                    
                    <div class="calendar-day @(isToday ? "today" : "") @(!isCurrentMonth ? "other-month" : "") @(dayAppointments.Any() ? "has-appointments" : "")">
                        <div class="calendar-day-number">@day.Day</div>
                        @if (dayAppointments.Any())
                        {
                            <div class="calendar-appointments">
                                @foreach (var apt in dayAppointments.Take(2))
                                {
                                    <div class="calendar-appointment @GetStatusClass(apt.Status) @(apt.IsFinished ? "appointment-finished" : apt.PatientArrived ? "appointment-checked-in" : "")" @onclick="() => SelectAppointment(apt)">
                                        @if (apt.IsFinished)
                                        {
                                            <span class="calendar-status-icon finished">‚úì‚úì</span>
                                        }
                                        else if (apt.PatientArrived)
                                        {
                                            <span class="calendar-status-icon checked-in">‚úì</span>
                                        }
                                        <div class="apt-time">@apt.TimeSlot</div>
                                        <div class="apt-doctor">Dr. @apt.Doctor?.LastName</div>
                                    </div>
                                }
                                @if (dayAppointments.Count() > 2)
                                {
                                    <div class="calendar-more">+@(dayAppointments.Count() - 2) more</div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
        </div>

        <div class="appointments-tabs">
            <button class="tab @(selectedTab == "all" ? "active" : "")" @onclick="@(() => selectedTab = "all")">
                All (@appointments.Count)
            </button>
            <button class="tab @(selectedTab == "upcoming" ? "active" : "")" @onclick="@(() => selectedTab = "upcoming")">
                Upcoming (@appointments.Count(a => a.Status == "Pending" || a.Status == "Confirmed"))
            </button>
            <button class="tab @(selectedTab == "completed" ? "active" : "")" @onclick="@(() => selectedTab = "completed")">
                Completed (@appointments.Count(a => a.Status == "Completed"))
            </button>
            <button class="tab @(selectedTab == "cancelled" ? "active" : "")" @onclick="@(() => selectedTab = "cancelled")">
                Cancelled (@appointments.Count(a => a.Status == "Cancelled"))
            </button>
        </div>

        <div class="appointments-list">
            @foreach (var appointment in FilteredAppointments)
            {
                <div class="appointment-card @GetStatusClass(appointment.Status) @(appointment.IsFinished ? "appointment-finished" : appointment.PatientArrived ? "appointment-checked-in" : "")">
                    <div class="appointment-header">
                        <div class="doctor-info">
                            @if (appointment.Doctor != null)
                            {
                                <img src="@appointment.Doctor.ImageUrl" alt="@appointment.Doctor.FullName" class="doctor-avatar" />
                                <div>
                                    <h3>Dr. @appointment.Doctor.FullName</h3>
                                    <p class="specialization">@appointment.Doctor.Specialization</p>
                                </div>
                            }
                        </div>
                        <div class="status-badge @GetStatusClass(appointment.Status)">
                            @appointment.Status
                        </div>
                    </div>

                    <div class="appointment-details">
                        <div class="detail-row">
                            <span class="detail-icon"></span>
                            <span class="detail-label">Date:</span>
                            <span class="detail-value">@appointment.AppointmentDate.ToString("MMMM dd, yyyy")</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-icon"></span>
                            <span class="detail-label">Time:</span>
                            <span class="detail-value">@appointment.TimeSlot</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-icon"></span>
                            <span class="detail-label">Patient:</span>
                            <span class="detail-value">@appointment.PatientName</span>
                        </div>
                        @if (!string.IsNullOrEmpty(appointment.Symptoms))
                        {
                            <div class="detail-row symptoms">
                                <span class="detail-icon"></span>
                                <span class="detail-label">Symptoms:</span>
                                <span class="detail-value">@appointment.Symptoms</span>
                            </div>
                        }
                        @if (appointment.Doctor != null)
                        {
                            <div class="detail-row">
                                <span class="detail-icon"></span>
                                <span class="detail-label">Fee:</span>
                                <span class="detail-value fee">$@appointment.Doctor.ConsultationFee</span>
                            </div>
                        }
                    </div>

                    <!-- Cancellation Period Info -->
                    @if (appointment.Status != "Cancelled" && appointment.Status != "Completed")
                    {
                        var cancellationInfo = GetCancellationInfo(appointment);
                        <div class="cancellation-info-box @(cancellationInfo.CanCancel ? "can-cancel" : "cannot-cancel")">
                            <div class="cancellation-icon">
                                @if (cancellationInfo.CanCancel)
                                {
                                    <span>‚úì</span>
                                }
                                else
                                {
                                    <span>‚è∞</span>
                                }
                            </div>
                            <div class="cancellation-text">
                                @if (cancellationInfo.CanCancel)
                                {
                                    <strong>Cancellation Allowed</strong>
                                    <p>You can cancel until @cancellationInfo.DeadlineText</p>
                                    <p class="time-remaining">Time remaining: @cancellationInfo.TimeRemaining</p>
                                }
                                else
                                {
                                    <strong>Cancellation Window Closed</strong>
                                    <p>@cancellationInfo.Message</p>
                                }
                            </div>
                        </div>
                    }

                    <div class="appointment-actions">
                        @if (appointment.PatientArrived)
                        {
                            <div class="checked-in-info">
                                <span class="checked-in-badge">
                                    ‚úì Checked In @appointment.PatientArrivedAt?.ToString("HH:mm")
                                </span>
                                @if (!string.IsNullOrEmpty(appointment.CheckedInByAssistantName))
                                {
                                    <span class="assistant-info">
                                        by @appointment.CheckedInByAssistantName
                                        @if (!string.IsNullOrEmpty(appointment.CheckedInByAssistantBarcode))
                                        {
                                            <span class="assistant-barcode">(@appointment.CheckedInByAssistantBarcode)</span>
                                        }
                                    </span>
                                }
                            </div>
                        }

                        @if (appointment.IsFinished)
                        {
                            <span class="finished-badge">‚úì Appointment Completed @appointment.FinishedAt?.ToString("MMM dd, HH:mm")</span>
                        }
                        
                        @if (appointment.Status != "Cancelled" && appointment.Status != "Completed")
                        {
                            var cancellationInfo = GetCancellationInfo(appointment);
                            <div class="cancel-button-container">
                                <button class="btn-cancel" 
                                        @onclick="() => CancelAppointment(appointment.Id)"
                                        disabled="@(!cancellationInfo.CanCancel)">
                                    @if (cancellationInfo.CanCancel)
                                    {
                                        <span>Cancel Appointment</span>
                                    }
                                    else
                                    {
                                        <span>Cannot Cancel</span>
                                    }
                                </button>
                                @if (cancellationInfo.CanCancel)
                                {
                                    <span class="time-left-indicator" style="color: #22c55e !important; font-weight: 800 !important; background: white !important; border: 3px solid #22c55e !important; padding: 0.625rem 1.25rem !important; border-radius: 0.625rem !important; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4) !important; margin-left: 2rem !important;">‚è±Ô∏è @cancellationInfo.TimeRemaining left</span>
                                }
                                else if (appointment.Status != "Cancelled" && appointment.Status != "Completed")
                                {
                                    <span class="time-left-indicator expired" style="color: #ef4444 !important; font-weight: 800 !important; background: white !important; border: 3px solid #ef4444 !important; padding: 0.625rem 1.25rem !important; border-radius: 0.625rem !important; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4) !important; margin-left: 2rem !important;">‚õî Deadline passed</span>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Appointment> appointments = new();
    private bool isLoading = true;
    private string selectedTab = "all";
    private DateTime currentDate = DateTime.Today;
    private Appointment? selectedAppointment = null;
    private Timer? countdownTimer;
    private DateTime currentTime = DateTime.Now;

    private IEnumerable<Appointment> FilteredAppointments
    {
        get
        {
            return selectedTab switch
            {
                "upcoming" => appointments.Where(a => a.Status == "Pending" || a.Status == "Confirmed"),
                "completed" => appointments.Where(a => a.Status == "Completed"),
                "cancelled" => appointments.Where(a => a.Status == "Cancelled"),
                _ => appointments
            };
        }
    }

    private List<DateTime> GetCalendarDays()
    {
        var days = new List<DateTime>();
        var firstDay = new DateTime(currentDate.Year, currentDate.Month, 1);
        var lastDay = firstDay.AddMonths(1).AddDays(-1);
        
        // Get day of week for first day (0 = Sunday)
        int startOffset = (int)firstDay.DayOfWeek;
        
        // Add previous month days
        for (int i = startOffset - 1; i >= 0; i--)
        {
            days.Add(firstDay.AddDays(-i - 1));
        }
        
        // Add current month days
        for (int i = 0; i < lastDay.Day; i++)
        {
            days.Add(firstDay.AddDays(i));
        }
        
        // Add next month days to complete the grid (42 days = 6 weeks)
        int remainingDays = 42 - days.Count;
        for (int i = 1; i <= remainingDays; i++)
        {
            days.Add(lastDay.AddDays(i));
        }
        
        return days;
    }

    private List<Appointment> GetAppointmentsForDay(DateTime day)
    {
        return appointments
            .Where(a => a.AppointmentDate.Date == day.Date)
            .OrderBy(a => a.TimeSlot)
            .ToList();
    }

    private void PreviousMonth()
    {
        currentDate = currentDate.AddMonths(-1);
    }

    private void NextMonth()
    {
        currentDate = currentDate.AddMonths(1);
    }

    private void SelectAppointment(Appointment appointment)
    {
        selectedAppointment = appointment;
        selectedTab = "all";
    }

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated())
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadAppointments();
        
        // Start real-time countdown timer
        countdownTimer = new Timer(async _ =>
        {
            currentTime = DateTime.Now;
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    public void Dispose()
    {
        countdownTimer?.Dispose();
    }

    private async Task LoadAppointments()
    {
        isLoading = true;
        appointments = await AppointmentService.GetUserAppointmentsAsync();
        isLoading = false;
    }

    private CancellationInfo GetCancellationInfo(Appointment appointment)
    {
        const int CANCELLATION_HOURS = 6; // 6 hours before appointment
        
        var appointmentDateTime = appointment.AppointmentDate;
        
        // Parse time from TimeSlot (e.g., "09:00 AM", "02:00 PM")
        if (DateTime.TryParse(appointment.TimeSlot, out var parsedTime))
        {
            appointmentDateTime = appointment.AppointmentDate.Date.Add(parsedTime.TimeOfDay);
        }
        else
        {
            // If parsing fails, log and assume end of day to be safe
            Console.WriteLine($"Failed to parse time slot: {appointment.TimeSlot}");
            appointmentDateTime = appointment.AppointmentDate.Date.AddHours(23).AddMinutes(59);
        }
        
        var cancellationDeadline = appointmentDateTime.AddHours(-CANCELLATION_HOURS);
        var now = currentTime; // Use the timer-updated current time
        var canCancel = now < cancellationDeadline;
        
        var timeRemaining = cancellationDeadline - now;
        string timeRemainingText = "";
        
        if (canCancel)
        {
            int days = (int)timeRemaining.TotalDays;
            int hours = timeRemaining.Hours;
            int minutes = timeRemaining.Minutes;
            int seconds = timeRemaining.Seconds;
            
            if (days > 0)
            {
                timeRemainingText = $"{days}d {hours}h {minutes}m {seconds}s";
            }
            else if (hours > 0)
            {
                timeRemainingText = $"{hours}h {minutes}m {seconds}s";
            }
            else if (minutes > 0)
            {
                timeRemainingText = $"{minutes}m {seconds}s";
            }
            else
            {
                timeRemainingText = $"{seconds}s";
            }
        }
        
        return new CancellationInfo
        {
            CanCancel = canCancel,
            DeadlineText = cancellationDeadline.ToString("MMM dd, yyyy hh:mm tt"),
            TimeRemaining = timeRemainingText,
            Message = canCancel 
                ? $"You can cancel until {CANCELLATION_HOURS} hours before your appointment."
                : $"Cancellation period ended. Deadline was {CANCELLATION_HOURS} hours before appointment."
        };
    }

    private async Task CancelAppointment(int appointmentId)
    {
        var appointment = appointments.FirstOrDefault(a => a.Id == appointmentId);
        if (appointment == null) return;
        
        var cancellationInfo = GetCancellationInfo(appointment);
        if (!cancellationInfo.CanCancel)
        {
            Console.WriteLine("Cannot cancel: Cancellation period has ended.");
            return;
        }
        
        if (confirm($"Are you sure you want to cancel this appointment?\n\nDoctor: Dr. {appointment.Doctor?.FullName}\nDate: {appointment.AppointmentDate:MMM dd, yyyy}\nTime: {appointment.TimeSlot}"))
        {
            var success = await AppointmentService.CancelAppointmentAsync(appointmentId);
            if (success)
            {
                Console.WriteLine("Appointment cancelled successfully.");
                await LoadAppointments();
            }
            else
            {
                Console.WriteLine("Failed to cancel appointment.");
            }
        }
    }

    private bool confirm(string message)
    {
        // In a real app, use a modal dialog
        return true;
    }

    private class CancellationInfo
    {
        public bool CanCancel { get; set; }
        public string DeadlineText { get; set; } = "";
        public string TimeRemaining { get; set; } = "";
        public string Message { get; set; } = "";
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "pending" => "status-pending",
            "confirmed" => "status-confirmed",
            "completed" => "status-completed",
            "cancelled" => "status-cancelled",
            _ => ""
        };
    }

    private void GoToDoctors()
    {
        Navigation.NavigateTo("/doctors");
    }

    private List<DoctorStatistic> GetDoctorStatistics()
    {
        return appointments
            .Where(a => a.Doctor != null)
            .GroupBy(a => new { a.Doctor!.Id, a.Doctor.FullName })
            .Select(g => new DoctorStatistic
            {
                DoctorName = g.Key.FullName,
                Count = g.Count()
            })
            .OrderByDescending(s => s.Count)
            .ToList();
    }

    private double GetBarWidth(int count)
    {
        if (!appointments.Any()) return 0;
        var maxCount = GetDoctorStatistics().Max(s => s.Count);
        return maxCount > 0 ? (count * 100.0 / maxCount) : 0;
    }

    private class DoctorStatistic
    {
        public string DoctorName { get; set; } = "";
        public int Count { get; set; }
    }
}
