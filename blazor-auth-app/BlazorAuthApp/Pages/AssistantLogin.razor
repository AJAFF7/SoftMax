@page "/assistant-login"
@using BlazorAuthApp.Models
@using BlazorAuthApp.Services
@using Microsoft.JSInterop
@inject AssistantService AssistantService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>SoftMax Portal - Assistant Login</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h2 class="text-white">ðŸ”‘ SoftMax Portal</h2>
            <p>Assistant Access - QR Code Sign-In</p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-error">
                @errorMessage
                @if (errorMessage.Contains("camera icon") || errorMessage.Contains("allow camera"))
                {
                    <div class="error-help">
                        <strong>How to enable camera:</strong>
                        <ol>
                            <li>Look for the camera icon (ðŸŽ¥ or ðŸ”’) in your browser's address bar</li>
                            <li>Click it and select "Allow" for camera access</li>
                            <li>Refresh the page and try again</li>
                        </ol>
                    </div>
                }
            </div>
        }

        @if (showScanner)
        {
            <div class="qr-scanner-section">
                <div class="scanner-header">
                    <h3 class="text-white">Scan Your QR Code</h3>
                    <p>Position the QR code within the camera frame</p>
                </div>
                <div id="qr-reader" style="width: 100%;"></div>
                <button type="button" class="btn-cancel" @onclick="StopQRScanner">
                    Cancel
                </button>
            </div>
        }
        else
        {
            <div class="qr-login-section">
                <div class="qr-login-info">
                    <div class="qr-icon"></div>
                    @* <h4>Scan QR Code to Login</h4>
                    <p>Click the button below to open your camera and scan your QR code badge</p> *@
                </div>
                <div class="text-center">
                    <button type="button" class="btn-qr-scan" @onclick="StartQRScanner">
                        Open Camera
                    </button>
                </div>
            </div>

            <div class="login-footer">
                <p>Regular user? <a href="/login">User Login</a></p>
            </div>
        }
    </div>
</div>

@code {
    private string errorMessage = string.Empty;
    private bool showScanner = false;
    private DotNetObjectReference<AssistantLogin>? dotNetHelper;

    protected override void OnInitialized()
    {
        dotNetHelper = DotNetObjectReference.Create(this);
    }

    private async Task StartQRScanner()
    {
        showScanner = true;
        errorMessage = string.Empty;
        StateHasChanged();
        
        await Task.Delay(100); // Wait for DOM to update
        
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.start", "qr-reader", dotNetHelper);
        }
        catch (Exception ex)
        {
            errorMessage = $"Camera error: {ex.Message}";
            showScanner = false;
        }
    }

    private async Task StopQRScanner()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.stop");
        }
        catch { }
        
        showScanner = false;
    }

    [JSInvokable]
    public async Task OnQRCodeScanned(string barcode)
    {
        await StopQRScanner();
        errorMessage = string.Empty;
        StateHasChanged();

        Console.WriteLine($"[AssistantLogin] QR Code scanned: {barcode}");

        var (success, message, assistant) = await AssistantService.LoginByBarcodeAsync(barcode);

        Console.WriteLine($"[AssistantLogin] Barcode login result - Success: {success}, Message: {message}");

        if (success && assistant != null)
        {
            Console.WriteLine($"[AssistantLogin] Barcode login successful, navigating to assistant dashboard");
            // Force a delay to ensure local storage is saved
            await Task.Delay(100);
            NavigationManager.NavigateTo("/assistant-dashboard", forceLoad: true);
        }
        else
        {
            Console.WriteLine($"[AssistantLogin] Barcode login failed: {message}");
            errorMessage = message;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnScanError(string error)
    {
        errorMessage = $"Scanner error: {error}";
        await StopQRScanner();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.stop");
        }
        catch { }
        
        dotNetHelper?.Dispose();
    }
}
