@page "/assistant-login"
@using BlazorAuthApp.Models
@using BlazorAuthApp.Services
@using Microsoft.JSInterop
@inject AssistantService AssistantService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>SoftMax Portal - Assistant Login</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h2>ðŸ”‘ SoftMax Portal</h2>
            <p>Assistant Access - QR Code Sign-In</p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-error">
                @errorMessage
            </div>
        }

        @if (!showScanner)
        {
            <div class="qr-login-section">
                <div class="qr-login-info">
                    <div class="qr-icon"></div>
                    <h3>Scan QR Code to Login</h3>
                    <p>Click the button below to open your camera and scan your QR code badge</p>
                </div>
                <button type="button" class="btn-qr-scan" @onclick="StartQRScanner">
                     Open Camera & Scan QR Code
                </button>
            </div>

            <div class="or-divider">
                <span>OR</span>
            </div>

            <div class="face-login-section">
                <div class="face-login-info">
                    <div class="face-icon">ðŸ‘¤</div>
                    <h3>Use Face Recognition</h3>
                    <p>Login instantly using facial recognition</p>
                </div>
                <button type="button" class="btn-face-scan" @onclick="StartFaceRecognition">
                     Open Camera & Scan Face
                </button>
            </div>

            <div class="login-footer">
                <p>Regular user? <a href="/login">User Login</a></p>
            </div>
        }
        else if (showScanner && !showFaceRecognition)
        {
            <div class="qr-scanner-section">
                <div class="scanner-header">
                    <h3>Scan Your QR Code</h3>
                    <p>Position the QR code within the camera frame</p>
                </div>
                <div id="qr-reader" style="width: 100%;"></div>
                <button type="button" class="btn-cancel" @onclick="StopQRScanner">
                    Cancel
                </button>
            </div>
        }
        else if (showFaceRecognition)
        {
            <div class="face-scanner-section">
                <div class="scanner-header">
                    <h3>Face Recognition</h3>
                    <p>@faceStatusMessage</p>
                </div>
                <div class="video-container">
                    <video id="face-video" autoplay muted playsinline></video>
                    @if (isFaceReady && !isProcessingFace)
                    {
                        <div class="face-overlay"></div>
                    }
                </div>
                @if (isFaceReady && !isProcessingFace)
                {
                    <button type="button" class="btn-capture-face" @onclick="CaptureFace">
                        Capture Face & Login
                    </button>
                }
                @if (isProcessingFace)
                {
                    <div class="processing-indicator">
                        <div class="spinner"></div>
                        <p>Processing...</p>
                    </div>
                }
                <button type="button" class="btn-cancel" @onclick="StopFaceRecognition" disabled="@isProcessingFace">
                    Cancel
                </button>
            </div>
        }
        else
        {
            <div class="qr-scanner-section">
                <div class="scanner-header">
                    <h3>Scan Your QR Code</h3>
                    <p>Position the QR code within the camera frame</p>
                </div>
                <div id="qr-reader" style="width: 100%;"></div>
                <button type="button" class="btn-cancel" @onclick="StopQRScanner">
                    Cancel
                </button>
            </div>
        }
    </div>
</div>

@code {
    private string errorMessage = string.Empty;
    private bool isLoading = false;
    private bool showScanner = false;
    private bool showFaceRecognition = false;
    private bool isFaceReady = false;
    private bool isProcessingFace = false;
    private string faceStatusMessage = "Initializing camera...";
    private DotNetObjectReference<AssistantLogin>? dotNetHelper;

    protected override void OnInitialized()
    {
        dotNetHelper = DotNetObjectReference.Create(this);
    }

    private async Task StartQRScanner()
    {
        showScanner = true;
        showFaceRecognition = false;
        errorMessage = string.Empty;
        StateHasChanged();
        
        await Task.Delay(100); // Wait for DOM to update
        
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.start", "qr-reader", dotNetHelper);
        }
        catch (Exception ex)
        {
            errorMessage = $"Camera error: {ex.Message}";
            showScanner = false;
        }
    }

    private async Task StopQRScanner()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.stop");
        }
        catch { }
        
        showScanner = false;
    }

    private async Task StartFaceRecognition()
    {
        showFaceRecognition = true;
        showScanner = false;
        errorMessage = string.Empty;
        isFaceReady = false;
        faceStatusMessage = "Initializing camera...";
        StateHasChanged();
        
        await Task.Delay(100); // Wait for DOM to update
        
        try
        {
            await JSRuntime.InvokeVoidAsync("faceRecognition.start", "face-video", dotNetHelper);
        }
        catch (Exception ex)
        {
            errorMessage = $"Camera error: {ex.Message}";
            showFaceRecognition = false;
            StateHasChanged();
        }
    }

    private async Task StopFaceRecognition()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("faceRecognition.stop");
        }
        catch { }
        
        showFaceRecognition = false;
        isFaceReady = false;
        isProcessingFace = false;
        faceStatusMessage = "Initializing camera...";
    }

    [JSInvokable]
    public void OnCameraReady()
    {
        isFaceReady = true;
        faceStatusMessage = "Camera ready! Position your face in the frame and click 'Capture Face & Login'";
        StateHasChanged();
    }

    private async Task CaptureFace()
    {
        isProcessingFace = true;
        faceStatusMessage = "Capturing face...";
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            var faceDescriptor = await JSRuntime.InvokeAsync<string>("faceRecognition.captureFace");
            
            if (string.IsNullOrEmpty(faceDescriptor))
            {
                isProcessingFace = false;
                faceStatusMessage = "Camera ready! Position your face in the frame and click 'Capture Face & Login'";
                StateHasChanged();
                return;
            }

            Console.WriteLine($"[AssistantLogin] Face captured, attempting login...");
            faceStatusMessage = "Verifying face...";
            StateHasChanged();

            var (success, message, assistant) = await AssistantService.LoginByFaceAsync(faceDescriptor);

            if (success && assistant != null)
            {
                Console.WriteLine($"[AssistantLogin] Face login successful, navigating to assistant dashboard");
                await StopFaceRecognition();
                await Task.Delay(100);
                NavigationManager.NavigateTo("/assistant-dashboard", forceLoad: true);
            }
            else
            {
                Console.WriteLine($"[AssistantLogin] Face login failed: {message}");
                errorMessage = message;
                await StopFaceRecognition();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[AssistantLogin] Face capture error: {ex.Message}");
            errorMessage = $"Error: {ex.Message}";
            isProcessingFace = false;
            faceStatusMessage = "Camera ready! Position your face in the frame and click 'Capture Face & Login'";
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnFaceError(string error)
    {
        errorMessage = $"{error}";
        isProcessingFace = false;
        if (error.Contains("No face detected") || error.Contains("Error capturing face"))
        {
            faceStatusMessage = "Camera ready! Position your face in the frame and click 'Capture Face & Login'";
        }
        else
        {
            await StopFaceRecognition();
        }
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnQRCodeScanned(string barcode)
    {
        await StopQRScanner();
        isLoading = true;
        errorMessage = string.Empty;
        StateHasChanged();

        Console.WriteLine($"[AssistantLogin] QR Code scanned: {barcode}");

        var (success, message, assistant) = await AssistantService.LoginByBarcodeAsync(barcode);

        Console.WriteLine($"[AssistantLogin] Barcode login result - Success: {success}, Message: {message}");

        if (success && assistant != null)
        {
            Console.WriteLine($"[AssistantLogin] Barcode login successful, navigating to assistant dashboard");
            // Force a delay to ensure local storage is saved
            await Task.Delay(100);
            NavigationManager.NavigateTo("/assistant-dashboard", forceLoad: true);
        }
        else
        {
            Console.WriteLine($"[AssistantLogin] Barcode login failed: {message}");
            errorMessage = message;
            isLoading = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnScanError(string error)
    {
        errorMessage = $"Scanner error: {error}";
        await StopQRScanner();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.stop");
            await JSRuntime.InvokeVoidAsync("faceRecognition.stop");
        }
        catch { }
        
        dotNetHelper?.Dispose();
    }
}
