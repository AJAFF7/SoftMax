@page "/assistant-login"
@using BlazorAuthApp.Models
@using BlazorAuthApp.Services
@using Microsoft.JSInterop
@inject AssistantService AssistantService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>SoftMax Portal - Assistant Login</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h2>üîë SoftMax Portal</h2>
            <p>Assistant Access - Scan QR Code or Enter Credentials</p>
        </div>

        <!-- <div class="alert alert-info" style="background: #e3f2fd; color: #1976d2; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
            <strong>üìù Test Credentials:</strong><br/>
            Username: <code>jaff</code> or Barcode: <code>AST-20260219-82632</code><br/>
            Password: <code>Jaff123!</code>
        </div> -->

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-error">
                @errorMessage
            </div>
        }

        @if (!showScanner)
        {
            <div class="qr-login-section">
                <button type="button" class="btn-qr-scan" @onclick="StartQRScanner">
                     Scan QR Code to Login
                </button>
                <div class="divider">
                    <span>OR</span>
                </div>
            </div>

            <EditForm Model="@loginRequest" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label>Username or Barcode</label>
                <InputText @bind-Value="loginRequest.Username" class="form-control" placeholder="Enter username " />
                <ValidationMessage For="@(() => loginRequest.Username)" />
            </div>

            <div class="form-group">
                <label>Password</label>
                <InputText @bind-Value="loginRequest.Password" type="password" class="form-control" placeholder="Enter your password" />
                <ValidationMessage For="@(() => loginRequest.Password)" />
            </div>

            <button type="submit" class="btn-login" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>Logging in...</span>
                }
                else
                {
                    <span>Login</span>
                }
            </button>
        </EditForm>

        <div class="login-footer">
            <p>Regular user? <a href="/login">User Login</a></p>
        </div>
        }
        else
        {
            <div class="qr-scanner-section">
                <div class="scanner-header">
                    <h3>Scan Your QR Code</h3>
                    <p>Position the QR code within the camera frame</p>
                </div>
                <div id="qr-reader" style="width: 100%;"></div>
                <button type="button" class="btn-cancel" @onclick="StopQRScanner">
                    Cancel
                </button>
            </div>
        }
    </div>
</div>

@code {
    private AssistantLoginRequest loginRequest = new();
    private string errorMessage = string.Empty;
    private bool isLoading = false;
    private bool showScanner = false;
    private DotNetObjectReference<AssistantLogin>? dotNetHelper;

    protected override void OnInitialized()
    {
        dotNetHelper = DotNetObjectReference.Create(this);
    }

    private async Task HandleLogin()
    {
        errorMessage = string.Empty;
        isLoading = true;

        Console.WriteLine($"[AssistantLogin] Form submitted");
        Console.WriteLine($"[AssistantLogin] Username field: '{loginRequest.Username}'");
        Console.WriteLine($"[AssistantLogin] Password field length: {loginRequest.Password?.Length ?? 0}");
        Console.WriteLine($"[AssistantLogin] Password field: '{loginRequest.Password}'");

        var (success, message, assistant) = await AssistantService.LoginAsync(loginRequest);

        Console.WriteLine($"[AssistantLogin] Result - Success: {success}, Message: '{message}'");

        if (success && assistant != null)
        {
            Console.WriteLine($"[AssistantLogin] Login successful, navigating to assistant dashboard");
            // Force a delay to ensure local storage is saved
            await Task.Delay(100);
            NavigationManager.NavigateTo("/assistant-dashboard", forceLoad: true);
        }
        else
        {
            Console.WriteLine($"[AssistantLogin] Login failed: {message}");
            errorMessage = $"Login failed: {message}";
        }

        isLoading = false;
        StateHasChanged();
    }

    private async Task StartQRScanner()
    {
        showScanner = true;
        errorMessage = string.Empty;
        StateHasChanged();
        
        await Task.Delay(100); // Wait for DOM to update
        
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.start", "qr-reader", dotNetHelper);
        }
        catch (Exception ex)
        {
            errorMessage = $"Camera error: {ex.Message}";
            showScanner = false;
        }
    }

    private async Task StopQRScanner()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.stop");
        }
        catch { }
        
        showScanner = false;
    }

    [JSInvokable]
    public async Task OnQRCodeScanned(string barcode)
    {
        await StopQRScanner();
        isLoading = true;
        errorMessage = string.Empty;
        StateHasChanged();

        Console.WriteLine($"[AssistantLogin] QR Code scanned: {barcode}");

        var (success, message, assistant) = await AssistantService.LoginByBarcodeAsync(barcode);

        Console.WriteLine($"[AssistantLogin] Barcode login result - Success: {success}, Message: {message}");

        if (success && assistant != null)
        {
            Console.WriteLine($"[AssistantLogin] Barcode login successful, navigating to assistant dashboard");
            // Force a delay to ensure local storage is saved
            await Task.Delay(100);
            NavigationManager.NavigateTo("/assistant-dashboard", forceLoad: true);
        }
        else
        {
            Console.WriteLine($"[AssistantLogin] Barcode login failed: {message}");
            errorMessage = message;
            isLoading = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnScanError(string error)
    {
        errorMessage = $"Scanner error: {error}";
        await StopQRScanner();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.stop");
        }
        catch { }
        
        dotNetHelper?.Dispose();
    }
}
