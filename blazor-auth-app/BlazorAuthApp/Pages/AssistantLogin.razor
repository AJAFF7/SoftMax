@page "/assistant-login"
@using BlazorAuthApp.Models
@using BlazorAuthApp.Services
@using Microsoft.JSInterop
@inject AssistantService AssistantService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>SoftMax Portal - Assistant Login</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h2>ðŸ”‘ SoftMax Portal</h2>
            <p>Assistant Access - QR Code Sign-In</p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-error">
                @errorMessage
            </div>
        }

        @if (!showScanner)
        {
            <div class="qr-login-section">
                <div class="qr-login-info">
                    <div class="qr-icon">ðŸ“±</div>
                    <h3>Scan QR Code to Login</h3>
                    <p>Click the button below to open your camera and scan your QR code badge</p>
                </div>
                <button type="button" class="btn-qr-scan" @onclick="StartQRScanner">
                     Open Camera & Scan QR Code
                </button>
            </div>

            <div class="login-footer">
                <p>Regular user? <a href="/login">User Login</a></p>
            </div>
        }
        else
        {
            <div class="qr-scanner-section">
                <div class="scanner-header">
                    <h3>Scan Your QR Code</h3>
                    <p>Position the QR code within the camera frame</p>
                </div>
                <div id="qr-reader" style="width: 100%;"></div>
                <button type="button" class="btn-cancel" @onclick="StopQRScanner">
                    Cancel
                </button>
            </div>
        }
    </div>
</div>

@code {
    private string errorMessage = string.Empty;
    private bool isLoading = false;
    private bool showScanner = false;
    private DotNetObjectReference<AssistantLogin>? dotNetHelper;

    protected override void OnInitialized()
    {
        dotNetHelper = DotNetObjectReference.Create(this);
    }

    private async Task StartQRScanner()
    {
        showScanner = true;
        errorMessage = string.Empty;
        StateHasChanged();
        
        await Task.Delay(100); // Wait for DOM to update
        
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.start", "qr-reader", dotNetHelper);
        }
        catch (Exception ex)
        {
            errorMessage = $"Camera error: {ex.Message}";
            showScanner = false;
        }
    }

    private async Task StopQRScanner()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.stop");
        }
        catch { }
        
        showScanner = false;
    }

    [JSInvokable]
    public async Task OnQRCodeScanned(string barcode)
    {
        await StopQRScanner();
        isLoading = true;
        errorMessage = string.Empty;
        StateHasChanged();

        Console.WriteLine($"[AssistantLogin] QR Code scanned: {barcode}");

        var (success, message, assistant) = await AssistantService.LoginByBarcodeAsync(barcode);

        Console.WriteLine($"[AssistantLogin] Barcode login result - Success: {success}, Message: {message}");

        if (success && assistant != null)
        {
            Console.WriteLine($"[AssistantLogin] Barcode login successful, navigating to assistant dashboard");
            // Force a delay to ensure local storage is saved
            await Task.Delay(100);
            NavigationManager.NavigateTo("/assistant-dashboard", forceLoad: true);
        }
        else
        {
            Console.WriteLine($"[AssistantLogin] Barcode login failed: {message}");
            errorMessage = message;
            isLoading = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnScanError(string error)
    {
        errorMessage = $"Scanner error: {error}";
        await StopQRScanner();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("qrScanner.stop");
        }
        catch { }
        
        dotNetHelper?.Dispose();
    }
}
